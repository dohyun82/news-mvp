<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>NewsBot 설정</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 0;
        padding: 24px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
        padding: 32px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        margin-top: 0;
        margin-bottom: 24px;
        color: #333;
        font-size: 24px;
      }
      .back-button {
        display: inline-block;
        margin-bottom: 24px;
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      .back-button:hover {
        background-color: #5a6268;
      }
      .section {
        margin-bottom: 32px;
      }
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }
      .form-help {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
      }
      input[type="text"],
      input[type="number"],
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
      }
      input[type="text"]:focus,
      input[type="number"]:focus,
      textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }
      textarea {
        min-height: 100px;
        resize: vertical;
      }
      .keywords-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 6px;
        min-height: 50px;
      }
      .keyword-tag {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        font-size: 13px;
        gap: 8px;
      }
      .keyword-tag .delete-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 16px;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
      }
      .keyword-tag .delete-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .add-keyword-group {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .add-keyword-group input {
        flex: 1;
      }
      .add-keyword-group button {
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      .add-keyword-group button:hover {
        background-color: #218838;
      }
      .add-keyword-group button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .save-button {
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.2s;
        width: 100%;
        margin-top: 24px;
      }
      .save-button:hover {
        background-color: #0056b3;
      }
      .save-button:active {
        background-color: #004085;
      }
      .save-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .message {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 14px;
      }
      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .empty-message {
        color: #6c757d;
        font-size: 13px;
        font-style: italic;
        padding: 12px;
        text-align: center;
      }
      .category-keywords-group {
        margin-bottom: 24px;
        padding: 16px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      .category-header {
        margin-bottom: 12px;
      }
      .category-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }
      .category-keyword-input {
        margin-top: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/review" class="back-button">← 뒤로가기</a>
      <h1>NewsBot 설정</h1>

      <div id="message-container"></div>

      <div class="section">
        <div class="section-title">뉴스 검색 키워드 관리</div>
        <div class="form-group">
          <label for="keyword-input">키워드 추가</label>
          <div class="form-help">
            쉼표로 구분하여 여러 키워드를 한 번에 추가할 수 있습니다.
          </div>
          <div class="add-keyword-group">
            <input
              type="text"
              id="keyword-input"
              placeholder="예: 현대백화점, 식권대장, vendys"
            />
            <button id="add-keyword-btn" onclick="addKeyword()">추가</button>
          </div>
        </div>
        <div class="form-group">
          <label>등록된 키워드 목록</label>
          <div class="form-help">
            키워드를 클릭하여 삭제할 수 있습니다.
          </div>
          <div id="keywords-list" class="keywords-list">
            <div class="empty-message">등록된 키워드가 없습니다.</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">카테고리 분류 키워드 관리</div>
        <div class="form-help" style="margin-bottom: 16px">
          뉴스 제목에 포함된 키워드를 기준으로 카테고리를 자동 분류합니다.
          여러 카테고리에 매칭되면 순서상 먼저 나오는 카테고리가 적용됩니다.
        </div>
        
        <!-- 그룹사 뉴스 키워드 -->
        <div class="category-keywords-group">
          <div class="category-header">
            <h3>그룹사 뉴스</h3>
          </div>
          <div class="form-group">
            <div class="add-keyword-group">
              <input
                type="text"
                id="keyword-input-그룹사"
                placeholder="예: 현대백화점, 식권대장"
                class="category-keyword-input"
              />
              <button onclick="addCategoryKeyword('그룹사')">추가</button>
            </div>
            <div id="keywords-list-그룹사" class="keywords-list"></div>
          </div>
        </div>

        <!-- 업계 뉴스 키워드 -->
        <div class="category-keywords-group">
          <div class="category-header">
            <h3>업계 뉴스</h3>
          </div>
          <div class="form-group">
            <div class="add-keyword-group">
              <input
                type="text"
                id="keyword-input-업계"
                placeholder="예: 모바일 식권, 푸드테크"
                class="category-keyword-input"
              />
              <button onclick="addCategoryKeyword('업계')">추가</button>
            </div>
            <div id="keywords-list-업계" class="keywords-list"></div>
          </div>
        </div>

        <!-- 참고 뉴스 키워드 -->
        <div class="category-keywords-group">
          <div class="category-header">
            <h3>참고 뉴스</h3>
          </div>
          <div class="form-group">
            <div class="add-keyword-group">
              <input
                type="text"
                id="keyword-input-참고"
                placeholder="예: MRO, 워크플레이스"
                class="category-keyword-input"
              />
              <button onclick="addCategoryKeyword('참고')">추가</button>
            </div>
            <div id="keywords-list-참고" class="keywords-list"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">최대 수집 뉴스 개수</div>
        <div class="form-group">
          <label for="max-articles-input">최대 수집 개수</label>
          <div class="form-help">
            한 번에 수집할 최대 뉴스 기사 개수를 설정합니다.
          </div>
          <input
            type="number"
            id="max-articles-input"
            min="1"
            value="30"
            placeholder="30"
          />
        </div>
      </div>

      <button id="save-button" class="save-button" onclick="saveSettings()">
        설정 저장
      </button>
    </div>

    <script>
      // 로컬 스토리지 키
      const STORAGE_KEY_KEYWORDS = "newsbot_keywords";
      const STORAGE_KEY_MAX_ARTICLES = "newsbot_max_articles";
      const STORAGE_KEY_CATEGORY_KEYWORDS = "newsbot_category_keywords";

      // 키워드 배열
      let keywords = [];
      
      // 카테고리별 키워드 딕셔너리
      let categoryKeywords = {
        "그룹사": [],
        "업계": [],
        "참고": []
      };

      // 페이지 로드 시 초기화
      window.addEventListener("DOMContentLoaded", async () => {
        await loadSettings();
        renderKeywords();
        renderCategoryKeywords();
      });

      // 설정 로드
      async function loadSettings() {
        // 로컬 스토리지에서 키워드 로드
        const storedKeywords = localStorage.getItem(STORAGE_KEY_KEYWORDS);
        if (storedKeywords) {
          keywords = JSON.parse(storedKeywords);
        } else {
          // 로컬 스토리지에 없으면 초기값 API 호출
          try {
            const res = await fetch("/api/settings/initial-values");
            const data = await res.json();
            if (data.keywords) {
              keywords = data.keywords
                .split(",")
                .map((k) => k.trim())
                .filter((k) => k.length > 0);
              localStorage.setItem(
                STORAGE_KEY_KEYWORDS,
                JSON.stringify(keywords)
              );
            }
          } catch (e) {
            console.error("초기값 로드 실패:", e);
          }
        }

        // 로컬 스토리지에서 최대 수집 개수 로드
        const storedMaxArticles = localStorage.getItem(
          STORAGE_KEY_MAX_ARTICLES
        );
        if (storedMaxArticles) {
          document.getElementById("max-articles-input").value =
            storedMaxArticles;
        } else {
          // 로컬 스토리지에 없으면 초기값 API 호출
          try {
            const res = await fetch("/api/settings/initial-values");
            const data = await res.json();
            if (data.max_articles) {
              document.getElementById("max-articles-input").value =
                data.max_articles;
              localStorage.setItem(
                STORAGE_KEY_MAX_ARTICLES,
                String(data.max_articles)
              );
            }
          } catch (e) {
            console.error("초기값 로드 실패:", e);
          }
        }

        // 로컬 스토리지에서 카테고리별 키워드 로드
        const storedCategoryKeywords = localStorage.getItem(
          STORAGE_KEY_CATEGORY_KEYWORDS
        );
        if (storedCategoryKeywords) {
          categoryKeywords = JSON.parse(storedCategoryKeywords);
        } else {
          // 로컬 스토리지에 없으면 초기값 API 호출
          try {
            const res = await fetch("/api/settings/initial-values");
            const data = await res.json();
            console.log("API 응답 데이터:", data);
            console.log("category_keywords:", data.category_keywords);
            if (data.category_keywords) {
              categoryKeywords = data.category_keywords;
              console.log("설정된 categoryKeywords:", categoryKeywords);
              localStorage.setItem(
                STORAGE_KEY_CATEGORY_KEYWORDS,
                JSON.stringify(categoryKeywords)
              );
            } else {
              console.warn("category_keywords가 API 응답에 없습니다.");
            }
          } catch (e) {
            console.error("카테고리 키워드 초기값 로드 실패:", e);
          }
        }
      }

      // 키워드 추가
      function addKeyword() {
        const input = document.getElementById("keyword-input");
        const value = input.value.trim();

        if (!value) {
          showMessage("키워드를 입력해주세요.", "error");
          return;
        }

        // 쉼표로 구분된 키워드 처리
        const newKeywords = value
          .split(",")
          .map((k) => k.trim())
          .filter((k) => k.length > 0);

        // 중복 제거
        newKeywords.forEach((kw) => {
          if (!keywords.includes(kw)) {
            keywords.push(kw);
          }
        });

        input.value = "";
        renderKeywords();
      }

      // 키워드 삭제
      function deleteKeyword(keyword) {
        keywords = keywords.filter((k) => k !== keyword);
        renderKeywords();
      }

      // 키워드 목록 렌더링
      function renderKeywords() {
        const container = document.getElementById("keywords-list");
        container.innerHTML = "";

        if (keywords.length === 0) {
          container.innerHTML =
            '<div class="empty-message">등록된 키워드가 없습니다.</div>';
          return;
        }

        keywords.forEach((keyword) => {
          const tag = document.createElement("div");
          tag.className = "keyword-tag";
          tag.innerHTML = `
            <span>${escapeHtml(keyword)}</span>
            <button class="delete-btn" onclick="deleteKeyword('${escapeHtml(
              keyword
            )}')" title="삭제">×</button>
          `;
          container.appendChild(tag);
        });
      }

      // 카테고리별 키워드 추가
      function addCategoryKeyword(category) {
        const input = document.getElementById(`keyword-input-${category}`);
        const value = input.value.trim();

        if (!value) {
          showMessage("키워드를 입력해주세요.", "error");
          return;
        }

        // 쉼표로 구분된 키워드 처리
        const newKeywords = value
          .split(",")
          .map((k) => k.trim())
          .filter((k) => k.length > 0);

        // 중복 제거 및 추가
        newKeywords.forEach((kw) => {
          if (!categoryKeywords[category].includes(kw)) {
            categoryKeywords[category].push(kw);
          }
        });

        input.value = "";
        renderCategoryKeywords();
        showMessage(`${category} 카테고리에 키워드가 추가되었습니다.`, "success");
      }

      // 카테고리별 키워드 삭제
      function deleteCategoryKeyword(category, keyword) {
        categoryKeywords[category] = categoryKeywords[category].filter(
          (k) => k !== keyword
        );
        renderCategoryKeywords();
        showMessage(`${category} 카테고리에서 키워드가 삭제되었습니다.`, "success");
      }

      // 카테고리별 키워드 렌더링
      function renderCategoryKeywords() {
        const categories = ["그룹사", "업계", "참고"];
        categories.forEach((category) => {
          const container = document.getElementById(`keywords-list-${category}`);
          if (!container) return;

          container.innerHTML = "";

          if (!categoryKeywords[category] || categoryKeywords[category].length === 0) {
            container.innerHTML =
              '<div class="empty-message">등록된 키워드가 없습니다.</div>';
            return;
          }

          categoryKeywords[category].forEach((keyword) => {
            const tag = document.createElement("div");
            tag.className = "keyword-tag";
            tag.innerHTML = `
              <span>${escapeHtml(keyword)}</span>
              <button class="delete-btn" onclick="deleteCategoryKeyword('${category}', '${escapeHtml(
                keyword
              )}')" title="삭제">×</button>
            `;
            container.appendChild(tag);
          });
        });
      }

      // 설정 저장
      async function saveSettings() {
        const maxArticlesInput = document.getElementById("max-articles-input");
        const maxArticles = parseInt(maxArticlesInput.value, 10);

        if (isNaN(maxArticles) || maxArticles <= 0) {
          showMessage("최대 수집 개수는 1 이상의 숫자여야 합니다.", "error");
          return;
        }

        // 로컬 스토리지에 저장
        localStorage.setItem(STORAGE_KEY_KEYWORDS, JSON.stringify(keywords));
        localStorage.setItem(STORAGE_KEY_MAX_ARTICLES, String(maxArticles));
        localStorage.setItem(STORAGE_KEY_CATEGORY_KEYWORDS, JSON.stringify(categoryKeywords));

        // 백엔드에 저장
        try {
          const keywordsString = keywords.join(",");
          const res = await fetch("/api/settings/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              keywords: keywordsString,
              max_articles: maxArticles,
              category_keywords: categoryKeywords,
            }),
          });

          if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || "저장 실패");
          }

          showMessage("설정이 저장되었습니다.", "success");
        } catch (e) {
          console.error("설정 저장 실패:", e);
          showMessage(`설정 저장 실패: ${e.message}`, "error");
        }
      }

      // 메시지 표시
      function showMessage(message, type) {
        const container = document.getElementById("message-container");
        container.innerHTML = `<div class="message ${type}">${escapeHtml(
          message
        )}</div>`;

        // 3초 후 자동 제거
        setTimeout(() => {
          container.innerHTML = "";
        }, 3000);
      }

      // HTML 이스케이프
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Enter 키로 키워드 추가
      document
        .getElementById("keyword-input")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            addKeyword();
          }
        });
    </script>
  </body>
</html>

