<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>NewsBot Í≤ÄÌÜ† ÌéòÏù¥ÏßÄ</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        box-sizing: border-box;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 24px;
        display: flex;
        flex-direction: column;
        background-color: #f5f5f5;
        position: relative;
      }
      h1 {
        margin-bottom: 12px;
      }
      h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        color: #333;
      }
      .news-container {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        flex: 1;
        min-height: 0;
        background-color: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .news-section {
        min-width: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .news-section:first-child {
        flex: 1;
      }
      .news-section:last-child {
        flex: 4;
      }
      .news-section h2 {
        margin-top: 0;
      }
      .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        background-color: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.2s;
      }
      .card:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      .draggable {
        cursor: grab;
      }
      .draggable:active {
        cursor: grabbing;
        opacity: 0.6;
      }
      .selected-news-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        flex: 1;
        min-height: 0;
      }
      .category-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        background-color: white;
        padding: 12px;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .category-section h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }
      .drop-zone {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
        min-height: 0;
      }
      .category-drop-zone {
        min-height: 0;
      }
      .drop-zone.drag-over {
        border-color: #4a90e2;
        background-color: #e8f4f8;
      }
      .drop-zone.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 14px;
      }
      .meta {
        color: #666;
        font-size: 12px;
        margin-top: 6px;
      }
      .actions button {
        margin-right: 8px;
      }
      button {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      button:active:not(:disabled) {
        background-color: #004085;
      }
      .category {
        font-weight: bold;
        margin-right: 8px;
      }
      .summary {
        margin-top: 8px;
        white-space: pre-wrap;
      }
      .description {
        color: #555;
        font-size: 14px;
        margin-top: 6px;
        margin-bottom: 8px;
        line-height: 1.5;
      }
      .pub-date {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
        margin-bottom: 8px;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 1;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-overlay.active {
        display: flex;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4a90e2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: white;
        margin-top: 16px;
        font-size: 16px;
      }
      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .settings-button {
        position: fixed;
        top: 24px;
        right: 24px;
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        z-index: 1000;
      }
      .settings-button:hover {
        background-color: #0056b3;
      }
      .settings-button:active {
        background-color: #004085;
      }
    </style>
  </head>
  <body>
    <button class="settings-button" onclick="window.location.href='/settings'">
      ÏÑ§Ï†ï
    </button>
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Ï≤òÎ¶¨ Ï§ë...</div>
      </div>
    </div>
    <div class="news-container">
      <div class="news-section">
        <div class="section-header">
          <h2>Ï†ÑÏ≤¥ Îâ¥Ïä§ Î™©Î°ù</h2>
        </div>
        <div style="margin-bottom: 12px; display: flex; gap: 8px">
          <button id="collect-btn" onclick="collect()">Îâ¥Ïä§ ÏàòÏßë</button>
          <button id="reset-btn" onclick="resetCollection()" disabled>
            Ï¥àÍ∏∞Ìôî
          </button>
        </div>
        <div
          id="all-news-list"
          style="flex: 1; overflow-y: auto; min-height: 0"
        ></div>
      </div>

      <div class="news-section">
        <div class="section-header">
          <h2>ÏÑ†ÌÉùÎêú Îâ¥Ïä§ Î™©Î°ù</h2>
        </div>
        <div style="margin-bottom: 12px">
          <button id="summarize-all-btn" onclick="summarizeAll()" disabled>
            Îâ¥Ïä§ ÏöîÏïΩ
          </button>
          <button id="send-slack-btn" onclick="sendSlack()" disabled>
            Ïä¨Îûô Ï†ÑÏÜ°
          </button>
        </div>
        <div id="selected-news-list" class="selected-news-container">
          <div class="category-section">
            <h3>Í∑∏Î£πÏÇ¨ Îâ¥Ïä§</h3>
            <div
              id="category-Í∑∏Î£πÏÇ¨"
              class="drop-zone category-drop-zone"
              data-category="Í∑∏Î£πÏÇ¨"
            ></div>
          </div>
          <div class="category-section">
            <h3>ÏóÖÍ≥Ñ Îâ¥Ïä§</h3>
            <div
              id="category-ÏóÖÍ≥Ñ"
              class="drop-zone category-drop-zone"
              data-category="ÏóÖÍ≥Ñ"
            ></div>
          </div>
          <div class="category-section">
            <h3>Ï∞∏Í≥† Îâ¥Ïä§</h3>
            <div
              id="category-Ï∞∏Í≥†"
              class="drop-zone category-drop-zone"
              data-category="Ï∞∏Í≥†"
            ></div>
          </div>
          <div class="category-section">
            <h3>ÏùΩÏùÑÍ±∞Î¶¨</h3>
            <div
              id="category-ÏùΩÏùÑÍ±∞Î¶¨"
              class="drop-zone category-drop-zone"
              data-category="ÏùΩÏùÑÍ±∞Î¶¨"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Î°úÎî© ÏÉÅÌÉú Í¥ÄÎ¶¨
      let isLoading = false;

      function showLoading(text = "Ï≤òÎ¶¨ Ï§ë...") {
        isLoading = true;
        const overlay = document.getElementById("loading-overlay");
        const loadingText = document.getElementById("loading-text");
        if (overlay) {
          overlay.classList.add("active");
        }
        if (loadingText) {
          loadingText.textContent = text;
        }
        // Î™®Îì† Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî (ÏÑ§Ï†ï Î≤ÑÌäº Ï†úÏô∏)
        document.querySelectorAll("button:not(.settings-button)").forEach((btn) => {
          btn.disabled = true;
        });
      }

      function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.classList.remove("active");
        }
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏïΩ/Î∞úÏÜ° Î≤ÑÌäºÏùÄ ÏöîÏïΩ ÏÉÅÌÉúÏóê Îî∞Îùº)
        updateButtons();
      }

      async function collect() {
        if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        try {
          showLoading("Îâ¥Ïä§ ÏàòÏßë Ï§ë...");
          await fetch("/api/collect", { method: "POST" });
          await refresh(); // refresh()ÏóêÏÑú updateButtons()Í∞Ä Ìò∏Ï∂úÎêòÏñ¥ Î≤ÑÌäº ÏÉÅÌÉúÍ∞Ä ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏Îê®
        } catch (error) {
          console.error("Îâ¥Ïä§ ÏàòÏßë Ï§ë Ïò§Î•ò:", error);
          alert("Îâ¥Ïä§ ÏàòÏßë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
          // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          await updateButtons();
        } finally {
          hideLoading();
        }
      }

      async function resetCollection() {
        // Î™®Îì† Îâ¥Ïä§ ÏÇ≠Ï†ú API Ìò∏Ï∂ú
        try {
          const res = await fetch("/api/review/list");
          const data = await res.json();

          // Î™®Îì† Îâ¥Ïä§ ÏÇ≠Ï†ú
          for (const article of data) {
            await fetch("/api/review/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: article.url }),
            });
          }

          // UI ÏÉàÎ°úÍ≥†Ïπ® Î∞è Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          await refresh();
        } catch (error) {
          console.error("Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò:", error);
          alert("Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        }
      }
      // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ Ìï®Ïàò (RFC 822 ÌòïÏãùÏùÑ ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†Å ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò)
      function formatDate(dateStr) {
        if (!dateStr) return "";
        try {
          const date = new Date(dateStr);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (e) {
          return dateStr; // ÌååÏã± Ïã§Ìå® Ïãú ÏõêÎ≥∏ Î∞òÌôò
        }
      }

      async function refresh() {
        // Ìïú Î≤àÏùò API Ìò∏Ï∂úÎ°ú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const res = await fetch("/api/review/list");
        const data = await res.json();
        
        // Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Î•º Í∞Å Ìï®ÏàòÏóê Ï†ÑÎã¨
        await refreshAllNews(data);
        await refreshSelectedNews(data);
        updateButtons(data);
      }

      function getSelectedCount() {
        const selectedList = document.getElementById("selected-news-list");
        return selectedList ? selectedList.children.length : 0;
      }

      async function updateButtons(data = null) {
        // Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏúºÎ©¥ API Ìò∏Ï∂ú
        if (!data) {
          const res = await fetch("/api/review/list");
          data = await res.json();
        }
        const selectedNews = data.filter((a) => a.selected);

        // Ï†ÑÏ≤¥ Îâ¥Ïä§ Í∞úÏàò ÌôïÏù∏
        const hasNews = data.length > 0;

        // Îâ¥Ïä§ ÏàòÏßë Î≤ÑÌäº: Í≤ÄÏÉâÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏùÑ ÎïåÎßå ÌôúÏÑ±Ìôî
        const collectBtn = document.getElementById("collect-btn");
        if (collectBtn) {
          collectBtn.disabled = hasNews;
        }

        // Ï¥àÍ∏∞Ìôî Î≤ÑÌäº: Í≤ÄÏÉâÎêú Îâ¥Ïä§Í∞Ä ÏûàÏùÑ ÎïåÎßå ÌôúÏÑ±Ìôî (ÏàòÏßë Î≤ÑÌäºÍ≥º Ï†ïÎ∞òÎåÄ)
        const resetBtn = document.getElementById("reset-btn");
        if (resetBtn) {
          resetBtn.disabled = !hasNews;
        }

        // ÏöîÏïΩÏù¥ Ïïà Îêú Îâ¥Ïä§Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
        const hasUnsummarized = selectedNews.some(
          (a) => !a.summary || a.summary.trim() === ""
        );

        // Î™®Îì† Îâ¥Ïä§Í∞Ä ÏöîÏïΩ ÏôÑÎ£åÎêòÏóàÎäîÏßÄ ÌôïÏù∏
        const allSummarized =
          selectedNews.length > 0 &&
          selectedNews.every((a) => a.summary && a.summary.trim() !== "");

        // Îâ¥Ïä§ ÏöîÏïΩ Î≤ÑÌäº: ÏöîÏïΩÏù¥ Ïïà Îêú Îâ¥Ïä§Í∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÌôúÏÑ±Ìôî
        const summarizeBtn = document.getElementById("summarize-all-btn");
        if (summarizeBtn) {
          summarizeBtn.disabled = !hasUnsummarized || selectedNews.length === 0;
        }

        // Ïä¨Îûô Î∞úÏÜ° Î≤ÑÌäº: Î™®Îì† Îâ¥Ïä§Í∞Ä ÏöîÏïΩ ÏôÑÎ£åÎêú Í≤ΩÏö∞ÏóêÎßå ÌôúÏÑ±Ìôî
        const sendSlackBtn = document.getElementById("send-slack-btn");
        if (sendSlackBtn) {
          sendSlackBtn.disabled = !allSummarized || selectedNews.length === 0;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function refreshAllNews(data = null) {
        // Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏúºÎ©¥ API Ìò∏Ï∂ú
        if (!data) {
          const res = await fetch("/api/review/list");
          data = await res.json();
        }
        const root = document.getElementById("all-news-list");
        root.innerHTML = "";

        const allNews = data.filter((a) => !a.selected);

        if (allNews.length === 0) {
          root.innerHTML =
            "<p style='color: #999;'>ÏàòÏßëÎêú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>";
          return;
        }

        for (const a of allNews) {
          const card = document.createElement("div");
          card.className = "card draggable";
          card.draggable = true;
          card.setAttribute("data-url", a.url);
          card.ondragstart = (e) => handleDragStart(e, a.url);
          card.ondragend = handleDragEnd;

          const escapedTitle = escapeHtml(a.title);
          const escapedDescription = a.description
            ? escapeHtml(a.description)
            : "";
          const escapedCategory = escapeHtml(a.category);

          card.innerHTML = `
            <div>
              <span class="category">[${escapedCategory}]</span>
              <a href="${
                a.url
              }" target="_blank" rel="noopener">${escapedTitle}</a>
            </div>
            ${
              escapedDescription
                ? `<div class="description">${escapedDescription}</div>`
                : ""
            }
            ${
              a.pub_date
                ? `<div class="pub-date">üìÖ ${formatDate(a.pub_date)}</div>`
                : ""
            }
            <div class="actions">
              <button class="remove-btn" data-url="${escapeHtml(
                a.url
              )}">ÏÇ≠Ï†ú</button>
            </div>
          `;
          const removeBtn = card.querySelector(".remove-btn");
          if (removeBtn) {
            removeBtn.addEventListener("click", () => removeItem(a.url));
          }
          root.appendChild(card);
        }
      }

      async function refreshSelectedNews(data = null) {
        // Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÎã¨ÎêòÏßÄ ÏïäÏúºÎ©¥ API Ìò∏Ï∂ú
        if (!data) {
          const res = await fetch("/api/review/list");
          data = await res.json();
        }
        const selectedNews = data.filter((a) => a.selected);

        // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Í∑∏Î£πÌôî
        const categories = ["Í∑∏Î£πÏÇ¨", "ÏóÖÍ≥Ñ", "Ï∞∏Í≥†", "ÏùΩÏùÑÍ±∞Î¶¨"];
        const newsByCategory = {};
        categories.forEach((cat) => {
          newsByCategory[cat] = selectedNews.filter((a) => a.category === cat);
        });

        // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ ÏòÅÏó≠Ïóê Îâ¥Ïä§ ÌëúÏãú
        categories.forEach((category) => {
          const categoryZone = document.getElementById(`category-${category}`);
          if (!categoryZone) return;

          categoryZone.innerHTML = "";

          const newsInCategory = newsByCategory[category] || [];

          if (newsInCategory.length === 0) {
            categoryZone.innerHTML =
              '<p class="empty-message">Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            categoryZone.classList.add("empty");
            return;
          }

          categoryZone.classList.remove("empty");

          newsInCategory.forEach((a) => {
            const card = document.createElement("div");
            card.className = "card draggable";
            card.draggable = true;
            card.setAttribute("data-url", a.url);
            card.ondragstart = (e) => handleDragStart(e, a.url);
            card.ondragend = handleDragEnd;

            const escapedTitle = escapeHtml(a.title);
            const escapedDescription = a.description
              ? escapeHtml(a.description)
              : "";
            const escapedCategory = escapeHtml(a.category);
            const escapedSummary = a.summary ? escapeHtml(a.summary) : "";

            card.innerHTML = `
              <div>
                <span class="category">[${escapedCategory}]</span>
                <a href="${
                  a.url
                }" target="_blank" rel="noopener">${escapedTitle}</a>
              </div>
              ${
                escapedDescription
                  ? `<div class="description">${escapedDescription}</div>`
                  : ""
              }
              ${
                a.pub_date
                  ? `<div class="pub-date">üìÖ ${formatDate(a.pub_date)}</div>`
                  : ""
              }
              <div class="actions">
                <button class="deselect-btn" data-url="${escapeHtml(
                  a.url
                )}">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
                <button class="summarize-btn" data-url="${escapeHtml(
                  a.url
                )}">Îâ¥Ïä§ ÏöîÏïΩ</button>
              </div>
              <div class="summary" id="s-${btoa(a.url)}">${escapedSummary}</div>
            `;
            const deselectBtn = card.querySelector(".deselect-btn");
            const summarizeBtn = card.querySelector(".summarize-btn");
            if (deselectBtn) {
              deselectBtn.addEventListener("click", () =>
                toggleSelect(a.url, false)
              );
            }
            if (summarizeBtn) {
              summarizeBtn.addEventListener("click", () => summarize(a.url));
            }
            categoryZone.appendChild(card);
          });
        });
      }

      function handleDragStart(event, url) {
        event.dataTransfer.setData("text/plain", url);
        event.dataTransfer.effectAllowed = "move";
        event.currentTarget.style.opacity = "0.6";
      }

      function handleDragEnd(event) {
        event.currentTarget.style.opacity = "1";
      }

      function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = "move";
        event.currentTarget.classList.add("drag-over");
      }

      function handleDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      async function handleDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        const url = event.dataTransfer.getData("text/plain");
        if (!url) return;

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏòÅÏó≠Ïóê ÎìúÎ°≠Îêú Í≤ΩÏö∞
        const category = event.currentTarget.getAttribute("data-category");
        if (category) {
          // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Îâ¥Ïä§Ïù∏ Í≤ΩÏö∞ Ïπ¥ÌÖåÍ≥†Î¶¨Îßå Î≥ÄÍ≤Ω
          const res = await fetch("/api/review/list");
          const data = await res.json();
          const article = data.find((a) => a.url === url);

          if (article && article.selected) {
            // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Îâ¥Ïä§Ïù∏ Í≤ΩÏö∞ Ïπ¥ÌÖåÍ≥†Î¶¨Îßå Î≥ÄÍ≤Ω
            const categoryRes = await fetch("/api/review/category", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, category }),
            });
            if (!categoryRes.ok) {
              let errorData;
              try {
                errorData = await categoryRes.json();
              } catch (e) {
                errorData = {
                  error: categoryRes.statusText || "Unknown error",
                };
              }
              const errorMessage =
                errorData.error?.message ||
                (typeof errorData.error === "object"
                  ? JSON.stringify(errorData.error)
                  : errorData.error) ||
                errorData.message ||
                categoryRes.statusText;
              console.error("Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω API Ìò∏Ï∂ú Ïã§Ìå®:", {
                status: categoryRes.status,
                statusText: categoryRes.statusText,
                errorData: errorData,
                url: url,
                category: category,
              });
              alert(
                `Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω Ïã§Ìå® (${categoryRes.status}): ${errorMessage}`
              );
              return;
            }
            await refresh();
          } else {
            // ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ Îâ¥Ïä§Ïù∏ Í≤ΩÏö∞: Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω ÌõÑ ÏÑ†ÌÉù Ï≤òÎ¶¨
            // Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î®ºÏ†Ä Î≥ÄÍ≤ΩÌïú ÌõÑ ÏÑ†ÌÉùÌïòÏó¨ Ïò¨Î∞îÎ•∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú ÌëúÏãúÎêòÎèÑÎ°ù Ìï®
            const categoryRes = await fetch("/api/review/category", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, category }),
            });
            if (!categoryRes.ok) {
              let errorData;
              try {
                errorData = await categoryRes.json();
              } catch (e) {
                errorData = {
                  error: categoryRes.statusText || "Unknown error",
                };
              }
              const errorMessage =
                errorData.error?.message ||
                (typeof errorData.error === "object"
                  ? JSON.stringify(errorData.error)
                  : errorData.error) ||
                errorData.message ||
                categoryRes.statusText;
              console.error("Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω API Ìò∏Ï∂ú Ïã§Ìå®:", {
                status: categoryRes.status,
                statusText: categoryRes.statusText,
                errorData: errorData,
                url: url,
                category: category,
              });
              alert(
                `Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω Ïã§Ìå® (${categoryRes.status}): ${errorMessage}`
              );
              return;
            }
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω ÌõÑ ÏÑ†ÌÉù API Ìò∏Ï∂ú
            const selectRes = await fetch("/api/review/select", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, selected: true }),
            });
            if (!selectRes.ok) {
              console.error("ÏÑ†ÌÉù API Ìò∏Ï∂ú Ïã§Ìå®");
              return;
            }
            // Î≥ÄÍ≤Ω ÏÇ¨Ìï≠Ïù¥ Î∞òÏòÅÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const verifyRes = await fetch("/api/review/list");
            const verifyData = await verifyRes.json();
            const verifiedArticle = verifyData.find((a) => a.url === url);
            if (
              verifiedArticle &&
              verifiedArticle.selected &&
              verifiedArticle.category === category
            ) {
              await refresh();
            } else {
              // Ïû¨ÏãúÎèÑ
              console.log("Ïπ¥ÌÖåÍ≥†Î¶¨ Î≥ÄÍ≤Ω ÌôïÏù∏ Ïã§Ìå®, Ïû¨ÏãúÎèÑ...");
              await new Promise((resolve) => setTimeout(resolve, 200));
              await refresh();
            }
          }
        } else {
          // Í∏∞Ï°¥ ÏÑ†ÌÉù ÏòÅÏó≠Ïóê ÎìúÎ°≠Îêú Í≤ΩÏö∞ (Í∏∞Ï°¥ ÎèôÏûë)
          await toggleSelect(url, true);
        }
      }

      async function summarizeAll() {
        if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        try {
          showLoading("Îâ¥Ïä§ ÏöîÏïΩ Ï§ë...");
          const res = await fetch("/api/review/list");
          const data = await res.json();
          const selectedNews = data.filter((a) => a.selected);

          const toSummarize = selectedNews.filter(
            (a) => !a.summary || a.summary.trim() === ""
          );
          const total = toSummarize.length;

          for (let i = 0; i < toSummarize.length; i++) {
            const a = toSummarize[i];
            showLoading(`Îâ¥Ïä§ ÏöîÏïΩ Ï§ë... (${i + 1}/${total})`);
            await summarize(a.url, true); // ÎÇ¥Î∂Ä Ìò∏Ï∂ú ÌîåÎûòÍ∑∏
            await new Promise((resolve) => setTimeout(resolve, 500));
          }
          await refresh();
        } catch (error) {
          console.error("ÏöîÏïΩ Ï§ë Ïò§Î•ò:", error);
          alert("ÏöîÏïΩ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function toggleSelect(url, selected) {
        if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        try {
          showLoading(selected ? "Îâ¥Ïä§ ÏÑ†ÌÉù Ï§ë..." : "Îâ¥Ïä§ ÏÑ†ÌÉù Ìï¥Ï†ú Ï§ë...");
          await fetch("/api/review/select", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url, selected }),
          });
          await refresh();
        } catch (error) {
          console.error("ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ï§ë Ïò§Î•ò:", error);
          alert("ÏÑ†ÌÉù Î≥ÄÍ≤Ω Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function summarize(url, isInternalCall = false) {
        // ÎÇ¥Î∂Ä Ìò∏Ï∂ú(summarizeAll)Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Î°úÎî© ÌëúÏãú
        if (!isInternalCall) {
          if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
          showLoading("Îâ¥Ïä§ ÏöîÏïΩ Ï§ë...");
        }
        try {
          console.log("summarize Ìï®Ïàò Ìò∏Ï∂úÎê®, URL:", url);
          const res = await fetch("/api/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });
          console.log("API ÏùëÎãµ ÏÉÅÌÉú:", res.status);
          const data = await res.json();
          console.log("API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:", data);
          const el = document.getElementById("s-" + btoa(url));
          if (el) {
            el.textContent = data.summary || "";
            console.log("ÏöîÏïΩ ÌëúÏãú ÏôÑÎ£å");
            // ÏÑ†ÌÉùÎêú Îâ¥Ïä§ Î™©Î°ùÎßå Í∞±Ïã† (ÏöîÏïΩÏù¥ ÌëúÏãúÎêú ÏòÅÏó≠Îßå)
            await refreshSelectedNews();
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            await updateButtons();
          } else {
            console.error(
              "ÏöîÏïΩÏùÑ ÌëúÏãúÌï† ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå, ID:",
              "s-" + btoa(url)
            );
          }
        } catch (error) {
          console.error("ÏöîÏïΩ Ï§ë ÏóêÎü¨ Î∞úÏÉù:", error);
          alert("ÏöîÏïΩ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
          if (!isInternalCall) {
            hideLoading();
          }
        }
      }
      async function removeItem(url) {
        if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        try {
          showLoading("Îâ¥Ïä§ ÏÇ≠Ï†ú Ï§ë...");
          await fetch("/api/review/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });
          await refresh();
        } catch (error) {
          console.error("ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò:", error);
          alert("ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function sendSlack() {
        if (isLoading) return; // Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
        try {
          showLoading("Ïä¨Îûô Î∞úÏÜ° Ï§ë...");
          const res = await fetch("/api/send-slack", { method: "POST" });
          const data = await res.json();
          alert(data.message || "ÏôÑÎ£å");
          
          // Ïä¨Îûô Ï†ÑÏÜ° ÏÑ±Í≥µ Ïãú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
          if (data.success) {
            const sendSlackBtn = document.getElementById("send-slack-btn");
            if (sendSlackBtn) {
              sendSlackBtn.disabled = true;
            }
          }
        } catch (error) {
          console.error("Ïä¨Îûô Î∞úÏÜ° Ï§ë Ïò§Î•ò:", error);
          alert("Ïä¨Îûô Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message);
        } finally {
          hideLoading();
        }
      }
      // ÎìúÎ°≠ Ï°¥ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
      document.addEventListener("DOMContentLoaded", async function () {
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        await updateButtons();
        // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨ ÏòÅÏó≠Ïóê ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Ï∂îÍ∞Ä
        const categories = ["Í∑∏Î£πÏÇ¨", "ÏóÖÍ≥Ñ", "Ï∞∏Í≥†", "ÏùΩÏùÑÍ±∞Î¶¨"];
        categories.forEach((category) => {
          const categoryZone = document.getElementById(`category-${category}`);
          if (categoryZone) {
            categoryZone.addEventListener("dragover", handleDragOver);
            categoryZone.addEventListener("dragleave", handleDragLeave);
            categoryZone.addEventListener("drop", handleDrop);
          }
        });
      });

      // initial load
      refresh();
    </script>
  </body>
</html>
