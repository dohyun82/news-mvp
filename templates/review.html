<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>NewsBot ê²€í†  í˜ì´ì§€</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 24px;
        display: flex;
        flex-direction: column;
      }
      h1 {
        margin-bottom: 12px;
      }
      h2 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        color: #333;
      }
      .news-container {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        flex: 1;
        min-height: 0;
      }
      .news-section {
        min-width: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .news-section:first-child {
        flex: 1;
      }
      .news-section:last-child {
        flex: 4;
      }
      .news-section h2 {
        margin-top: 0;
      }
      .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .draggable {
        cursor: grab;
      }
      .draggable:active {
        cursor: grabbing;
        opacity: 0.6;
      }
      .selected-news-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        flex: 1;
        min-height: 0;
      }
      .category-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
      }
      .category-section h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }
      .drop-zone {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
        transition: all 0.2s ease;
        min-height: 0;
      }
      .category-drop-zone {
        min-height: 0;
      }
      .drop-zone.drag-over {
        border-color: #4a90e2;
        background-color: #e8f4f8;
      }
      .drop-zone.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 14px;
      }
      .meta {
        color: #666;
        font-size: 12px;
        margin-top: 6px;
      }
      .actions button {
        margin-right: 8px;
      }
      .category {
        font-weight: bold;
        margin-right: 8px;
      }
      .summary {
        margin-top: 8px;
        white-space: pre-wrap;
      }
      .description {
        color: #555;
        font-size: 14px;
        margin-top: 6px;
        margin-bottom: 8px;
        line-height: 1.5;
      }
      .pub-date {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
        margin-bottom: 8px;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .loading-overlay.active {
        display: flex;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4a90e2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: white;
        margin-top: 16px;
        font-size: 16px;
      }
      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">ì²˜ë¦¬ ì¤‘...</div>
      </div>
    </div>
    <div class="news-container">
      <div class="news-section">
        <div class="section-header">
          <h2>ì „ì²´ ë‰´ìŠ¤ ëª©ë¡</h2>
        </div>
        <div style="margin-bottom: 12px">
          <button id="collect-btn" onclick="collect()">ë‰´ìŠ¤ ìˆ˜ì§‘</button>
        </div>
        <div
          id="all-news-list"
          style="flex: 1; overflow-y: auto; min-height: 0"
        ></div>
      </div>

      <div class="news-section">
        <div class="section-header">
          <h2>ì„ íƒëœ ë‰´ìŠ¤ ëª©ë¡</h2>
        </div>
        <div style="margin-bottom: 12px">
          <button id="summarize-all-btn" onclick="summarizeAll()" disabled>
            ë‰´ìŠ¤ ìš”ì•½í•˜ê¸°
          </button>
          <button id="send-slack-btn" onclick="sendSlack()" disabled>
            ìŠ¬ë™ìœ¼ë¡œ ë°œì†¡
          </button>
        </div>
        <div id="selected-news-list" class="selected-news-container">
          <div class="category-section">
            <h3>ê·¸ë£¹ì‚¬ ë‰´ìŠ¤</h3>
            <div
              id="category-ê·¸ë£¹ì‚¬"
              class="drop-zone category-drop-zone"
              data-category="ê·¸ë£¹ì‚¬"
            ></div>
          </div>
          <div class="category-section">
            <h3>ì—…ê³„ ë‰´ìŠ¤</h3>
            <div
              id="category-ì—…ê³„"
              class="drop-zone category-drop-zone"
              data-category="ì—…ê³„"
            ></div>
          </div>
          <div class="category-section">
            <h3>ì°¸ê³  ë‰´ìŠ¤</h3>
            <div
              id="category-ì°¸ê³ "
              class="drop-zone category-drop-zone"
              data-category="ì°¸ê³ "
            ></div>
          </div>
          <div class="category-section">
            <h3>ì½ì„ê±°ë¦¬</h3>
            <div
              id="category-ì½ì„ê±°ë¦¬"
              class="drop-zone category-drop-zone"
              data-category="ì½ì„ê±°ë¦¬"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ë¡œë”© ìƒíƒœ ê´€ë¦¬
      let isLoading = false;

      function showLoading(text = "ì²˜ë¦¬ ì¤‘...") {
        isLoading = true;
        const overlay = document.getElementById("loading-overlay");
        const loadingText = document.getElementById("loading-text");
        if (overlay) {
          overlay.classList.add("active");
        }
        if (loadingText) {
          loadingText.textContent = text;
        }
        // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll("button").forEach((btn) => {
          btn.disabled = true;
        });
      }

      function hideLoading() {
        isLoading = false;
        const overlay = document.getElementById("loading-overlay");
        if (overlay) {
          overlay.classList.remove("active");
        }
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ìš”ì•½/ë°œì†¡ ë²„íŠ¼ì€ ìš”ì•½ ìƒíƒœì— ë”°ë¼)
        updateButtons();
      }

      async function collect() {
        if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        try {
          showLoading("ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘...");
          await fetch("/api/collect", { method: "POST" });
          await refresh();
        } catch (error) {
          console.error("ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }
      // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (RFC 822 í˜•ì‹ì„ ì‚¬ìš©ì ì¹œí™”ì  í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
      function formatDate(dateStr) {
        if (!dateStr) return "";
        try {
          const date = new Date(dateStr);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (e) {
          return dateStr; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
        }
      }

      async function refresh() {
        await refreshAllNews();
        await refreshSelectedNews();
        updateButtons();
      }

      function getSelectedCount() {
        const selectedList = document.getElementById("selected-news-list");
        return selectedList ? selectedList.children.length : 0;
      }

      async function updateButtons() {
        // ì„ íƒëœ ë‰´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const res = await fetch("/api/review/list");
        const data = await res.json();
        const selectedNews = data.filter((a) => a.selected);

        // ìš”ì•½ì´ ì•ˆ ëœ ë‰´ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
        const hasUnsummarized = selectedNews.some(
          (a) => !a.summary || a.summary.trim() === ""
        );

        // ëª¨ë“  ë‰´ìŠ¤ê°€ ìš”ì•½ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
        const allSummarized =
          selectedNews.length > 0 &&
          selectedNews.every((a) => a.summary && a.summary.trim() !== "");

        // ë‰´ìŠ¤ ìš”ì•½í•˜ê¸° ë²„íŠ¼: ìš”ì•½ì´ ì•ˆ ëœ ë‰´ìŠ¤ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í™œì„±í™”
        const summarizeBtn = document.getElementById("summarize-all-btn");
        if (summarizeBtn) {
          summarizeBtn.disabled = !hasUnsummarized || selectedNews.length === 0;
        }

        // ìŠ¬ë™ ë°œì†¡ ë²„íŠ¼: ëª¨ë“  ë‰´ìŠ¤ê°€ ìš”ì•½ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í™œì„±í™”
        const sendSlackBtn = document.getElementById("send-slack-btn");
        if (sendSlackBtn) {
          sendSlackBtn.disabled = !allSummarized || selectedNews.length === 0;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      async function refreshAllNews() {
        const res = await fetch("/api/review/list");
        const data = await res.json();
        const root = document.getElementById("all-news-list");
        root.innerHTML = "";

        const allNews = data.filter((a) => !a.selected);

        if (allNews.length === 0) {
          root.innerHTML =
            "<p style='color: #999;'>ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        for (const a of allNews) {
          const card = document.createElement("div");
          card.className = "card draggable";
          card.draggable = true;
          card.setAttribute("data-url", a.url);
          card.ondragstart = (e) => handleDragStart(e, a.url);
          card.ondragend = handleDragEnd;

          const escapedTitle = escapeHtml(a.title);
          const escapedDescription = a.description
            ? escapeHtml(a.description)
            : "";
          const escapedCategory = escapeHtml(a.category);

          card.innerHTML = `
            <div>
              <span class="category">[${escapedCategory}]</span>
              <a href="${
                a.url
              }" target="_blank" rel="noopener">${escapedTitle}</a>
            </div>
            ${
              escapedDescription
                ? `<div class="description">${escapedDescription}</div>`
                : ""
            }
            ${
              a.pub_date
                ? `<div class="pub-date">ğŸ“… ${formatDate(a.pub_date)}</div>`
                : ""
            }
            <div class="actions">
              <button class="remove-btn" data-url="${escapeHtml(
                a.url
              )}">ì‚­ì œ</button>
            </div>
          `;
          const removeBtn = card.querySelector(".remove-btn");
          if (removeBtn) {
            removeBtn.addEventListener("click", () => removeItem(a.url));
          }
          root.appendChild(card);
        }
      }

      async function refreshSelectedNews() {
        const res = await fetch("/api/review/list");
        const data = await res.json();
        const selectedNews = data.filter((a) => a.selected);

        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
        const categories = ["ê·¸ë£¹ì‚¬", "ì—…ê³„", "ì°¸ê³ ", "ì½ì„ê±°ë¦¬"];
        const newsByCategory = {};
        categories.forEach((cat) => {
          newsByCategory[cat] = selectedNews.filter((a) => a.category === cat);
        });

        // ê° ì¹´í…Œê³ ë¦¬ ì˜ì—­ì— ë‰´ìŠ¤ í‘œì‹œ
        categories.forEach((category) => {
          const categoryZone = document.getElementById(`category-${category}`);
          if (!categoryZone) return;

          categoryZone.innerHTML = "";

          const newsInCategory = newsByCategory[category] || [];

          if (newsInCategory.length === 0) {
            categoryZone.innerHTML =
              '<p class="empty-message">ì´ ì¹´í…Œê³ ë¦¬ì— ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            categoryZone.classList.add("empty");
            return;
          }

          categoryZone.classList.remove("empty");

          newsInCategory.forEach((a) => {
            const card = document.createElement("div");
            card.className = "card draggable";
            card.draggable = true;
            card.setAttribute("data-url", a.url);
            card.ondragstart = (e) => handleDragStart(e, a.url);
            card.ondragend = handleDragEnd;

            const escapedTitle = escapeHtml(a.title);
            const escapedDescription = a.description
              ? escapeHtml(a.description)
              : "";
            const escapedCategory = escapeHtml(a.category);
            const escapedSummary = a.summary ? escapeHtml(a.summary) : "";

            card.innerHTML = `
              <div>
                <span class="category">[${escapedCategory}]</span>
                <a href="${
                  a.url
                }" target="_blank" rel="noopener">${escapedTitle}</a>
              </div>
              ${
                escapedDescription
                  ? `<div class="description">${escapedDescription}</div>`
                  : ""
              }
              ${
                a.pub_date
                  ? `<div class="pub-date">ğŸ“… ${formatDate(a.pub_date)}</div>`
                  : ""
              }
              <div class="actions">
                <button class="deselect-btn" data-url="${escapeHtml(
                  a.url
                )}">ì„ íƒ í•´ì œ</button>
                <button class="summarize-btn" data-url="${escapeHtml(
                  a.url
                )}">ë‰´ìŠ¤ ìš”ì•½í•˜ê¸°</button>
              </div>
              <div class="summary" id="s-${btoa(a.url)}">${escapedSummary}</div>
            `;
            const deselectBtn = card.querySelector(".deselect-btn");
            const summarizeBtn = card.querySelector(".summarize-btn");
            if (deselectBtn) {
              deselectBtn.addEventListener("click", () =>
                toggleSelect(a.url, false)
              );
            }
            if (summarizeBtn) {
              summarizeBtn.addEventListener("click", () => summarize(a.url));
            }
            categoryZone.appendChild(card);
          });
        });
      }

      function handleDragStart(event, url) {
        event.dataTransfer.setData("text/plain", url);
        event.dataTransfer.effectAllowed = "move";
        event.currentTarget.style.opacity = "0.6";
      }

      function handleDragEnd(event) {
        event.currentTarget.style.opacity = "1";
      }

      function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = "move";
        event.currentTarget.classList.add("drag-over");
      }

      function handleDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      async function handleDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        const url = event.dataTransfer.getData("text/plain");
        if (!url) return;

        // ì¹´í…Œê³ ë¦¬ ì˜ì—­ì— ë“œë¡­ëœ ê²½ìš°
        const category = event.currentTarget.getAttribute("data-category");
        if (category) {
          // ì´ë¯¸ ì„ íƒëœ ë‰´ìŠ¤ì¸ ê²½ìš° ì¹´í…Œê³ ë¦¬ë§Œ ë³€ê²½
          const res = await fetch("/api/review/list");
          const data = await res.json();
          const article = data.find((a) => a.url === url);

          if (article && article.selected) {
            // ì´ë¯¸ ì„ íƒëœ ë‰´ìŠ¤ì¸ ê²½ìš° ì¹´í…Œê³ ë¦¬ë§Œ ë³€ê²½
            const categoryRes = await fetch("/api/review/category", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, category }),
            });
            if (!categoryRes.ok) {
              let errorData;
              try {
                errorData = await categoryRes.json();
              } catch (e) {
                errorData = {
                  error: categoryRes.statusText || "Unknown error",
                };
              }
              const errorMessage =
                errorData.error?.message ||
                (typeof errorData.error === "object"
                  ? JSON.stringify(errorData.error)
                  : errorData.error) ||
                errorData.message ||
                categoryRes.statusText;
              console.error("ì¹´í…Œê³ ë¦¬ ë³€ê²½ API í˜¸ì¶œ ì‹¤íŒ¨:", {
                status: categoryRes.status,
                statusText: categoryRes.statusText,
                errorData: errorData,
                url: url,
                category: category,
              });
              alert(
                `ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹¤íŒ¨ (${categoryRes.status}): ${errorMessage}`
              );
              return;
            }
            await refresh();
          } else {
            // ì„ íƒë˜ì§€ ì•Šì€ ë‰´ìŠ¤ì¸ ê²½ìš°: ì¹´í…Œê³ ë¦¬ ë³€ê²½ í›„ ì„ íƒ ì²˜ë¦¬
            // ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ë³€ê²½í•œ í›„ ì„ íƒí•˜ì—¬ ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ë¡œ í‘œì‹œë˜ë„ë¡ í•¨
            const categoryRes = await fetch("/api/review/category", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, category }),
            });
            if (!categoryRes.ok) {
              let errorData;
              try {
                errorData = await categoryRes.json();
              } catch (e) {
                errorData = {
                  error: categoryRes.statusText || "Unknown error",
                };
              }
              const errorMessage =
                errorData.error?.message ||
                (typeof errorData.error === "object"
                  ? JSON.stringify(errorData.error)
                  : errorData.error) ||
                errorData.message ||
                categoryRes.statusText;
              console.error("ì¹´í…Œê³ ë¦¬ ë³€ê²½ API í˜¸ì¶œ ì‹¤íŒ¨:", {
                status: categoryRes.status,
                statusText: categoryRes.statusText,
                errorData: errorData,
                url: url,
                category: category,
              });
              alert(
                `ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹¤íŒ¨ (${categoryRes.status}): ${errorMessage}`
              );
              return;
            }
            // ì¹´í…Œê³ ë¦¬ ë³€ê²½ í›„ ì„ íƒ API í˜¸ì¶œ
            const selectRes = await fetch("/api/review/select", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url, selected: true }),
            });
            if (!selectRes.ok) {
              console.error("ì„ íƒ API í˜¸ì¶œ ì‹¤íŒ¨");
              return;
            }
            // ë³€ê²½ ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const verifyRes = await fetch("/api/review/list");
            const verifyData = await verifyRes.json();
            const verifiedArticle = verifyData.find((a) => a.url === url);
            if (
              verifiedArticle &&
              verifiedArticle.selected &&
              verifiedArticle.category === category
            ) {
              await refresh();
            } else {
              // ì¬ì‹œë„
              console.log("ì¹´í…Œê³ ë¦¬ ë³€ê²½ í™•ì¸ ì‹¤íŒ¨, ì¬ì‹œë„...");
              await new Promise((resolve) => setTimeout(resolve, 200));
              await refresh();
            }
          }
        } else {
          // ê¸°ì¡´ ì„ íƒ ì˜ì—­ì— ë“œë¡­ëœ ê²½ìš° (ê¸°ì¡´ ë™ì‘)
          await toggleSelect(url, true);
        }
      }

      async function summarizeAll() {
        if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        try {
          showLoading("ë‰´ìŠ¤ ìš”ì•½ ì¤‘...");
          const res = await fetch("/api/review/list");
          const data = await res.json();
          const selectedNews = data.filter((a) => a.selected);

          const toSummarize = selectedNews.filter(
            (a) => !a.summary || a.summary.trim() === ""
          );
          const total = toSummarize.length;

          for (let i = 0; i < toSummarize.length; i++) {
            const a = toSummarize[i];
            showLoading(`ë‰´ìŠ¤ ìš”ì•½ ì¤‘... (${i + 1}/${total})`);
            await summarize(a.url, true); // ë‚´ë¶€ í˜¸ì¶œ í”Œë˜ê·¸
            await new Promise((resolve) => setTimeout(resolve, 500));
          }
          await refresh();
        } catch (error) {
          console.error("ìš”ì•½ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function toggleSelect(url, selected) {
        if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        try {
          showLoading(selected ? "ë‰´ìŠ¤ ì„ íƒ ì¤‘..." : "ë‰´ìŠ¤ ì„ íƒ í•´ì œ ì¤‘...");
          await fetch("/api/review/select", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url, selected }),
          });
          await refresh();
        } catch (error) {
          console.error("ì„ íƒ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ì„ íƒ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function summarize(url, isInternalCall = false) {
        // ë‚´ë¶€ í˜¸ì¶œ(summarizeAll)ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë¡œë”© í‘œì‹œ
        if (!isInternalCall) {
          if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
          showLoading("ë‰´ìŠ¤ ìš”ì•½ ì¤‘...");
        }
        try {
          console.log("summarize í•¨ìˆ˜ í˜¸ì¶œë¨, URL:", url);
          const res = await fetch("/api/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });
          console.log("API ì‘ë‹µ ìƒíƒœ:", res.status);
          const data = await res.json();
          console.log("API ì‘ë‹µ ë°ì´í„°:", data);
          const el = document.getElementById("s-" + btoa(url));
          if (el) {
            el.textContent = data.summary || "";
            console.log("ìš”ì•½ í‘œì‹œ ì™„ë£Œ");
            // ì„ íƒëœ ë‰´ìŠ¤ ëª©ë¡ë§Œ ê°±ì‹  (ìš”ì•½ì´ í‘œì‹œëœ ì˜ì—­ë§Œ)
            await refreshSelectedNews();
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            await updateButtons();
          } else {
            console.error(
              "ìš”ì•½ì„ í‘œì‹œí•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ID:",
              "s-" + btoa(url)
            );
          }
        } catch (error) {
          console.error("ìš”ì•½ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
          alert("ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          if (!isInternalCall) {
            hideLoading();
          }
        }
      }
      async function removeItem(url) {
        if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        try {
          showLoading("ë‰´ìŠ¤ ì‚­ì œ ì¤‘...");
          await fetch("/api/review/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });
          await refresh();
        } catch (error) {
          console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }
      async function sendSlack() {
        if (isLoading) return; // ì´ë¯¸ ë¡œë”© ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
        try {
          showLoading("ìŠ¬ë™ ë°œì†¡ ì¤‘...");
          const res = await fetch("/api/send-slack", { method: "POST" });
          const data = await res.json();
          alert(data.message || "ì™„ë£Œ");
        } catch (error) {
          console.error("ìŠ¬ë™ ë°œì†¡ ì¤‘ ì˜¤ë¥˜:", error);
          alert("ìŠ¬ë™ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
          hideLoading();
        }
      }
      // ë“œë¡­ ì¡´ ì´ë²¤íŠ¸ ì„¤ì •
      document.addEventListener("DOMContentLoaded", function () {
        // ê° ì¹´í…Œê³ ë¦¬ ì˜ì—­ì— ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
        const categories = ["ê·¸ë£¹ì‚¬", "ì—…ê³„", "ì°¸ê³ ", "ì½ì„ê±°ë¦¬"];
        categories.forEach((category) => {
          const categoryZone = document.getElementById(`category-${category}`);
          if (categoryZone) {
            categoryZone.addEventListener("dragover", handleDragOver);
            categoryZone.addEventListener("dragleave", handleDragLeave);
            categoryZone.addEventListener("drop", handleDrop);
          }
        });
      });

      // initial load
      refresh();
    </script>
  </body>
</html>
