<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>NewsBot ê²€í†  í˜ì´ì§€</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 24px;
      }
      h1 {
        margin-bottom: 12px;
      }
      .toolbar {
        margin-bottom: 16px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .meta {
        color: #666;
        font-size: 12px;
        margin-top: 6px;
      }
      .actions button {
        margin-right: 8px;
      }
      .category {
        font-weight: bold;
        margin-right: 8px;
      }
      .summary {
        margin-top: 8px;
        white-space: pre-wrap;
      }
      .description {
        color: #555;
        font-size: 14px;
        margin-top: 6px;
        margin-bottom: 8px;
        line-height: 1.5;
      }
      .pub-date {
        color: #888;
        font-size: 12px;
        margin-top: 4px;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <h1>NewsBot ê²€í†  í˜ì´ì§€</h1>
    <div class="toolbar">
      <button onclick="collect()">ë‰´ìŠ¤ ìˆ˜ì§‘</button>
      <button onclick="sendSlack()">ìŠ¬ë™ìœ¼ë¡œ ë°œì†¡</button>
    </div>
    <div id="list"></div>

    <script>
      async function collect() {
        await fetch("/api/collect", { method: "POST" });
        await refresh();
      }
      // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (RFC 822 í˜•ì‹ì„ ì‚¬ìš©ì ì¹œí™”ì  í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
      function formatDate(dateStr) {
        if (!dateStr) return "";
        try {
          const date = new Date(dateStr);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        } catch (e) {
          return dateStr; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
        }
      }

      async function refresh() {
        const res = await fetch("/api/review/list");
        const data = await res.json();
        const root = document.getElementById("list");
        root.innerHTML = "";
        for (const a of data) {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div>
              <span class="category">[${a.category}]</span>
              <a href="${a.url}" target="_blank" rel="noopener">${a.title}</a>
            </div>
            ${
              a.description
                ? `<div class="description">${a.description}</div>`
                : ""
            }
            ${
              a.pub_date
                ? `<div class="pub-date">ğŸ“… ${formatDate(a.pub_date)}</div>`
                : ""
            }
            <div class="meta">ì„ íƒë¨: ${a.selected ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"}</div>
            <div class="actions">
              <button onclick="toggleSelect('${a.url}', ${!a.selected})">${
            a.selected ? "ì„ íƒ í•´ì œ" : "ì„ íƒ"
          }</button>
              <button onclick="summarize('${a.url}')">ë‰´ìŠ¤ ìš”ì•½í•˜ê¸°</button>
              <button onclick="removeItem('${a.url}')">ì‚­ì œ</button>
            </div>
            <div class="summary" id="s-${btoa(a.url)}">${a.summary || ""}</div>
          `;
          root.appendChild(card);
        }
      }
      async function toggleSelect(url, selected) {
        await fetch("/api/review/select", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, selected }),
        });
        await refresh();
      }
      async function summarize(url) {
        console.log("summarize í•¨ìˆ˜ í˜¸ì¶œë¨, URL:", url);
        try {
          const res = await fetch("/api/summarize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
          });
          console.log("API ì‘ë‹µ ìƒíƒœ:", res.status);
          const data = await res.json();
          console.log("API ì‘ë‹µ ë°ì´í„°:", data);
          const el = document.getElementById("s-" + btoa(url));
          if (el) {
            el.textContent = data.summary || "";
            console.log("ìš”ì•½ í‘œì‹œ ì™„ë£Œ");
          } else {
            console.error(
              "ìš”ì•½ì„ í‘œì‹œí•  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ID:",
              "s-" + btoa(url)
            );
          }
        } catch (error) {
          console.error("ìš”ì•½ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
          alert("ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
      }
      async function removeItem(url) {
        await fetch("/api/review/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });
        await refresh();
      }
      async function sendSlack() {
        const res = await fetch("/api/send-slack", { method: "POST" });
        const data = await res.json();
        alert(data.message || "ì™„ë£Œ");
      }
      // initial load
      refresh();
    </script>
  </body>
</html>
